# Архитектура Context-Aware Logging

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Telegram Message                              │
│                    (от пользователя 12345)                           │
└────────────────────────────────┬──────────────────────────────────────┘
                                  │
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   UserContextMiddleware                               │
│  1. Извлекает user_id из message.from_user.id                        │
│  2. Вызывает set_user_context(12345)                                 │
└────────────────────────────────┬──────────────────────────────────────┘
                                  │
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       contextvars                                     │
│            current_user_id = 12345                                    │
│        (хранится в асинхронном контексте)                             │
└────────────────────────────────┬──────────────────────────────────────┘
                                  │
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Handler Function                                  │
│   async def process_city(message, state):                             │
│       logger.info("Processing city input")  ←── Обычный вызов         │
└────────────────────────────────┬──────────────────────────────────────┘
                                  │
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    UserContextFilter                                  │
│  1. Вызывает get_user_context()                                       │
│  2. Получает user_id = 12345                                         │
│  3. Форматирует: record.user_id = "user_12345 | "                    │
└────────────────────────────────┬──────────────────────────────────────┘
                                  │
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Log Formatter                                    │
│   '%(asctime)s EET | %(user_id)s%(levelname)s:%(name)s:%(message)s'  │
└────────────────────────────────┬──────────────────────────────────────┘
                                  │
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        Output                                         │
│  2025-12-11 18:18:14 EET | user_12345 | INFO:...:Processing city     │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   Finally Block (Middleware)                          │
│           clear_user_context()                                        │
│           current_user_id = None                                      │
└─────────────────────────────────────────────────────────────────────┘
```

## Ключевые особенности:

1. **Автоматизация**: user_id добавляется автоматически middleware
2. **Прозрачность**: не нужно изменять существующий код
3. **Изоляция**: каждый запрос имеет свой изолированный контекст
4. **Безопасность**: автоматическая очистка в finally гарантирует отсутствие утечек
5. **Async-safe**: contextvars работает корректно с async/await

## Пример работы в реальном времени:

```
┌──────────────┬──────────────────────────────────────────────────────┐
│ Время        │ Лог                                                  │
├──────────────┼──────────────────────────────────────────────────────┤
│ 10:15:01     │ INFO:bot:Bot started                                 │
│              │ (нет user_id - системный лог)                        │
│              │                                                      │
│ 10:15:05     │ user_12345 | INFO:handlers:User requested /start    │
│              │ (запрос от user 12345)                               │
│              │                                                      │
│ 10:15:05     │ user_12345 | INFO:handlers:Sending welcome message  │
│              │ (тот же запрос)                                      │
│              │                                                      │
│ 10:15:06     │ user_67890 | INFO:handlers:User requested /check    │
│              │ (новый запрос от user 67890)                         │
│              │                                                      │
│ 10:15:06     │ user_67890 | INFO:parser:Fetching schedule          │
│              │ (тот же запрос user 67890)                           │
│              │                                                      │
│ 10:15:10     │ INFO:tasks:Background check started                 │
│              │ (нет user_id - фоновая задача)                       │
│              │                                                      │
│ 10:15:11     │ user_11111 | INFO:tasks:Sending alert notification  │
│              │ (alert для user 11111, контекст установлен вручную)  │
└──────────────┴──────────────────────────────────────────────────────┘
```

## Фильтрация в action:

```bash
# Все запросы от user_12345
$ grep 'user_12345' bot.log

2025-12-11 10:15:05 EET | user_12345 | INFO:handlers:User requested /start
2025-12-11 10:15:05 EET | user_12345 | INFO:handlers:Sending welcome message
2025-12-11 10:16:30 EET | user_12345 | INFO:handlers:User requested /check
2025-12-11 10:16:30 EET | user_12345 | INFO:parser:Fetching schedule
2025-12-11 10:16:31 EET | user_12345 | INFO:handlers:Sending schedule response
```
