# ‚úÖ Group Cache Optimization - IMPLEMENTATION COMPLETE

## üéâ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚úÖ
- **–ú–∏–≥—Ä–∞—Ü–∏—è**: `005_group_schedule_cache.sql`
- **–¢–∞–±–ª–∏—Ü—ã**:
  - `group_schedule_cache` - –∫—ç—à –≥—Ä–∞—Ñ–∏–∫–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º (TTL 15 –º–∏–Ω, –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∫–ª—é—á group_name + provider)
  - `address_group_mapping` - –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∞–¥—Ä–µ—Å ‚Üí –≥—Ä—É–ø–ø–∞
- **–°—Ç–∞—Ç—É—Å**: –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫ –æ–±–µ–∏–º –ë–î (dtek, cek) ‚úÖ

### 2. API –§—É–Ω–∫—Ü–∏–∏ ‚úÖ
**–§–∞–π–ª**: `common/bot_base.py`
- `get_group_cache()` - –ø–æ–ª—É—á–∏—Ç—å –∫—ç—à –≥—Ä—É–ø–ø—ã
- `update_group_cache()` - –æ–±–Ω–æ–≤–∏—Ç—å –∫—ç—à –≥—Ä—É–ø–ø—ã
- `get_group_for_address()` - —É–∑–Ω–∞—Ç—å –≥—Ä—É–ø–ø—É –¥–ª—è –∞–¥—Ä–µ—Å–∞ (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏)
- `get_cached_group_for_address()` - —É–∑–Ω–∞—Ç—å –≥—Ä—É–ø–ø—É –∏–∑ subscriptions/user_last_check
- `update_address_group_mapping()` - –∑–∞–ø–∏—Å–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –∞–¥—Ä–µ—Å ‚Üí –≥—Ä—É–ø–ø–∞
- `find_addresses_by_group()` - –Ω–∞–π—Ç–∏ –∞–¥—Ä–µ—Å–∞ –ø–æ –≥—Ä—É–ø–ø–µ (–¥–ª—è –±—É–¥—É—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ /check_group)

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Code ‚úÖ

#### A. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ (`common/tasks.py`)
**–§—É–Ω–∫—Ü–∏—è**: `subscription_checker_task` (—Å—Ç—Ä–æ–∫–∏ 287-365)

**–õ–æ–≥–∏–∫–∞**:
```python
for address in addresses_to_check:
    # 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–≤–µ—Å—Ç–Ω–∞ –ª–∏ –≥—Ä—É–ø–ø–∞
    cached_group = await get_group_for_address(...)
    
    if cached_group:
        # 2. –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à –≥—Ä—É–ø–ø—ã
        group_cache = await get_group_cache(...)
        
        if group_cache:
            # ‚úì CACHE HIT - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞
            data = group_cache['data']
            current_hash = group_cache['hash']
        else:
            # ‚úó CACHE MISS - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
            data = await get_shutdowns_data(...)
    else:
        # –ì—Ä—É–ø–ø–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞ - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        data = await get_shutdowns_data(...)
    
    # 3. –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –≥—Ä—É–ø–ø—ã
    if data.get('group'):
        await update_group_cache(...)
        
    # 4. –û–±–Ω–æ–≤–ª—è–µ–º address_group_mapping (–Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π)
    if data.get('group'):
        await update_address_group_mapping(...)
```

**–û—Ç–ª–∏—á–∏–µ –æ—Ç –¥–æ**: –†–∞–Ω—å—à–µ –≤—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–ª—Å—è –ø–∞—Ä—Å–µ—Ä, —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∫—ç—à –≥—Ä—É–ø–ø—ã.

#### B. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã (`common/handlers.py`)
**–§—É–Ω–∫—Ü–∏—è**: `perform_address_check` (—Å—Ç—Ä–æ–∫–∏ 918-980)

**–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤**:
- `/check` - –ø—Ä—è–º–∞—è –∫–æ–º–∞–Ω–¥–∞
- `/repeat` - –ø–æ–≤—Ç–æ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
- Callback –æ—Ç –≤—ã–±–æ—Ä–∞ –∞–¥—Ä–µ—Å–∞ –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö

**–¢–∞ –∂–µ –ª–æ–≥–∏–∫–∞**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ ‚Üí fallback –Ω–∞ –ø–∞—Ä—Å–µ—Ä ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –∏ –º–∞–ø–ø–∏–Ω–≥–∞

### 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚úÖ
–î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –ª–æ–≥–∏:
- `‚úì Cache HIT for <address>, group <X.Y>` - –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à
- `‚úó Cache MISS for <address>, group <X.Y>` - –∫–æ–≥–¥–∞ –∫—ç—à —É—Å—Ç–∞—Ä–µ–ª
- `Updated group cache for <X.Y>` - –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫—ç—à–∞
- `Updated address-group mapping: <address> -> <X.Y>` - –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π

### 5. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ‚úÖ
- `docs/group_caching_architecture.md` - –ø–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- `docs/group_caching_next_steps.md` - –ø–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è
- `docs/group_caching_implementation_complete.md` - —ç—Ç–æ—Ç —Ñ–∞–π–ª

## üìä –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A: /check –º. –î–Ω—ñ–ø—Ä–æ, –≤—É–ª. –°–æ–Ω—è—á–Ω–∞ –Ω–∞–±–µ—Ä–µ–∂–Ω–∞, 6

1. get_group_for_address() ‚Üí None (–∞–¥—Ä–µ—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω)
2. –ó–∞–ø—Ä–æ—Å –∫ –ø–∞—Ä—Å–µ—Ä—É DTEK
3. –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç: group = "3.1", schedule = {...}
4. update_group_cache("3.1", ...) ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –≤ –∫—ç—à
5. update_address_group_mapping(...) ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –∞–¥—Ä–µ—Å —Å –≥—Ä—É–ø–ø–æ–π
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –≥—Ä–∞—Ñ–∏–∫
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –î—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Ç–æ—Ç –∂–µ –∞–¥—Ä–µ—Å (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 15 –º–∏–Ω)
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B: /check –º. –î–Ω—ñ–ø—Ä–æ, –≤—É–ª. –°–æ–Ω—è—á–Ω–∞ –Ω–∞–±–µ—Ä–µ–∂–Ω–∞, 6

1. get_group_for_address() ‚Üí "3.1" (–Ω–∞–π–¥–µ–Ω –≤ address_group_mapping)
2. get_group_cache("3.1") ‚Üí –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞ (age: 5 –º–∏–Ω)
3. ‚úì –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à, –ë–ï–ó –∑–∞–ø—Ä–æ—Å–∞ –∫ –ø–∞—Ä—Å–µ—Ä—É
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –≥—Ä–∞—Ñ–∏–∫ –ú–ì–ù–û–í–ï–ù–ù–û
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –î—Ä—É–≥–æ–π –∞–¥—Ä–µ—Å —Ç–æ–π –∂–µ –≥—Ä—É–ø–ø—ã
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å C: /check –º. –î–Ω—ñ–ø—Ä–æ, –≤—É–ª. –Ü–Ω—à–∞ –≤—É–ª–∏—Ü—è, 10

1. get_group_for_address() ‚Üí None (–Ω–æ–≤—ã–π –∞–¥—Ä–µ—Å)
2. –ó–∞–ø—Ä–æ—Å –∫ –ø–∞—Ä—Å–µ—Ä—É DTEK
3. –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç: group = "3.1", schedule = {...}
4. update_group_cache("3.1", ...) ‚Üí –∫—ç—à —É–∂–µ —Å–≤–µ–∂–∏–π, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
5. update_address_group_mapping(...) ‚Üí –ù–û–í–´–ô –∞–¥—Ä–µ—Å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π!
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –≥—Ä–∞—Ñ–∏–∫

–¢–µ–ø–µ—Ä—å –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π: 2 –∞–¥—Ä–µ—Å–∞ –¥–ª—è –≥—Ä—É–ø–ø—ã 3.1
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (–∫—ç—à —Å–≤–µ–∂–∏–π)
```
–í—Ä–µ–º—è –ø—Ä–∏—à–ª–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ (interval_hours –ø—Ä–æ—à—ë–ª)

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ A, B, C –≤—Å–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ —Ä–∞–∑–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –≥—Ä—É–ø–ø—ã 3.1:

1. –ê–¥—Ä–µ—Å A: get_group_for_address() ‚Üí "3.1"
2.          get_group_cache("3.1") ‚Üí ‚úì –∫—ç—à —Å–≤–µ–∂–∏–π (age: 12 –º–∏–Ω)
3.          –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à, –ë–ï–ó –ø–∞—Ä—Å–µ—Ä–∞

4. –ê–¥—Ä–µ—Å B: get_group_for_address() ‚Üí "3.1"  
5.          get_group_cache("3.1") ‚Üí ‚úì —Ç–æ—Ç –∂–µ –∫—ç—à
6.          –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à, –ë–ï–ó –ø–∞—Ä—Å–µ—Ä–∞

7. –ê–¥—Ä–µ—Å C: get_group_for_address() ‚Üí "3.1"
8.          get_group_cache("3.1") ‚Üí ‚úì —Ç–æ—Ç –∂–µ –∫—ç—à  
9.          –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à, –ë–ï–ó –ø–∞—Ä—Å–µ—Ä–∞

–ò–¢–û–ì–û: 3 –ø—Ä–æ–≤–µ—Ä–∫–∏, 0 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ DTEK, 100% cache hit rate
```

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ú–µ—Ç—Ä–∏–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**:
- 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–¥—Ä–µ—Å–∞–º–∏ —Ä–∞–∑–Ω—ã—Ö –≥—Ä—É–ø–ø ‚Üí 100 –∑–∞–ø—Ä–æ—Å–æ–≤/—Ü–∏–∫–ª –∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 5-15 —Å–µ–∫—É–Ω–¥ (–ø–∞—Ä—Å–∏–Ω–≥)

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**:
- 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ 10 –≥—Ä—É–ø–ø ‚Üí ~10 –∑–∞–ø—Ä–æ—Å–æ–≤/15 –º–∏–Ω –∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É
- –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö: 0-1 –∑–∞–ø—Ä–æ—Å (–µ—Å–ª–∏ –≤—Å–µ –∫—ç—à–∏ —Å–≤–µ–∂–∏–µ)
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –∏–∑ –∫—ç—à–∞: < 1 —Å–µ–∫—É–Ω–¥–∞
- **–°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏**: ~90-99%

### –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π

–ö–∞–∂–¥–∞—è –Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ `address_group_mapping`:

```sql
-- –î–µ–Ω—å 1
SELECT COUNT(*) FROM address_group_mapping;
-- 50 –∞–¥—Ä–µ—Å–æ–≤

-- –ù–µ–¥–µ–ª—è 1  
SELECT COUNT(*) FROM address_group_mapping;
-- 200 –∞–¥—Ä–µ—Å–æ–≤

-- –ú–µ—Å—è—Ü 1
SELECT COUNT(*) FROM address_group_mapping;
-- 1000+ –∞–¥—Ä–µ—Å–æ–≤
```

–≠—Ç–∞ –±–∞–∑–∞ –≥–æ—Ç–æ–≤–∏—Ç –ø–æ—á–≤—É –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ `/check_group X.Y`.

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç

#### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –ë–î
```bash
sqlite3 dtek/bot/dtek_bot.db
> SELECT * FROM group_schedule_cache;
> SELECT * FROM address_group_mapping LIMIT 10;
```

#### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏ –±–æ—Ç–∞
```bash
docker-compose logs -f dtek-bot | grep -E "Cache (HIT|MISS)|Updated group"
```

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏**:
```
INFO: ‚úì Cache HIT for `–º. –î–Ω—ñ–ø—Ä–æ, –≤—É–ª. –°–æ–Ω—è—á–Ω–∞ –Ω–∞–±–µ—Ä–µ–∂–Ω–∞, 6`, group 3.1 (age: fresh)
DEBUG: Updated group cache for 3.1 (dtek), hash: abc123...
DEBUG: Updated address-group mapping: –º. –î–Ω—ñ–ø—Ä–æ, –≤—É–ª. –°–æ–Ω—è—á–Ω–∞ –Ω–∞–±–µ—Ä–µ–∂–Ω–∞, 6 -> 3.1 (dtek)
```

#### 3. –¢–µ—Å—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π

**A. –ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç**:
1. `/check –º. –î–Ω—ñ–ø—Ä–æ, –≤—É–ª. –°–æ–Ω—è—á–Ω–∞ –Ω–∞–±–µ—Ä–µ–∂–Ω–∞, 6` (–ø–µ—Ä–≤—ã–π —Ä–∞–∑)
   - –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—Ä–æ—Å –∫ –ø–∞—Ä—Å–µ—Ä—É
   - –õ–æ–≥: "Updated group cache"
   
2. `/check –º. –î–Ω—ñ–ø—Ä–æ, –≤—É–ª. –°–æ–Ω—è—á–Ω–∞ –Ω–∞–±–µ—Ä–µ–∂–Ω–∞, 6` (—Å—Ä–∞–∑—É –ø–æ—Å–ª–µ)
   - –î–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à
   - –õ–æ–≥: "‚úì Cache HIT"
   - –û—Ç–≤–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π

**B. –¢–µ—Å—Ç –ø–æ–¥–ø–∏—Å–æ–∫**:
1. –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ 3 —Ä–∞–∑–Ω—ã—Ö –∞–¥—Ä–µ—Å–∞ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã
2. –ü–æ–¥–æ–∂–¥–∞—Ç—å –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏
3. –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   - 1 –∑–∞–ø—Ä–æ—Å –∫ –ø–∞—Ä—Å–µ—Ä—É (–¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∞–¥—Ä–µ—Å–∞)
   - 2 Cache HIT (–¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–∑ —Ç–æ–π –∂–µ –≥—Ä—É–ø–ø—ã)

#### 4. –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**Hit Rate**:
```python
# –î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏ –≤ tasks.py
cache_hits = 0
cache_misses = 0

# –í –∫–æ–Ω—Ü–µ —Ü–∏–∫–ª–∞:
hit_rate = cache_hits / (cache_hits + cache_misses) * 100
logger.info(f"Cache hit rate: {hit_rate:.1f}% ({cache_hits}/{cache_hits + cache_misses})")
```

**–†–æ—Å—Ç –±–∞–∑—ã –∞–¥—Ä–µ—Å–æ–≤**:
```sql
SELECT 
    provider,
    COUNT(*) as total_addresses,
    COUNT(DISTINCT group_name) as unique_groups
FROM address_group_mapping
GROUP BY provider;
```

## üöÄ Production Readiness

### ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [x] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- [x] API —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [x] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ subscription_checker_task
- [x] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ user handlers (check/repeat)
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞–ø–∏—Å–∞–Ω–∞
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 2-3 –¥–Ω—è)
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ (hit rate, request count)
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫—ç—à–∞

### üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ production

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤** (2-3 –¥–Ω—è):
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ cache hits –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç
   - –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ë–î –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
   - –ö—ç—à –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—Å—Ç–∞—Ä–µ–≤–∞–µ—Ç —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**:
   - –°—Ä–∞–≤–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç –ø–∞—Ä—Å–µ—Ä–∞
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ö—ç—à–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç

3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ TTL** (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):
   - –¢–µ–∫—É—â–∏–π TTL: 15 –º–∏–Ω—É—Ç
   - –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ `bot_base.py`: `GROUP_CACHE_TTL_MINUTES = 15`
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: 10-30 –º–∏–Ω—É—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–∞—Å—Ç–æ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞–≥—Ä—É–∑–∫–∏**:
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É –¥–æ/–ø–æ—Å–ª–µ
   - –ï—Å–ª–∏ –∑–∞–º–µ—Ç–Ω—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ - —É–≤–µ–ª–∏—á–∏—Ç—å TTL

## üîÆ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### Phase 2: –ö–æ–º–∞–Ω–¥–∞ /check_group

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–∫–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ —Ç–æ–ª—å–∫–æ –ø–æ –Ω–æ–º–µ—Ä—É –≥—Ä—É–ø–ø—ã:

```python
async def handle_check_group_command(message: types.Message, ctx: BotContext):
    """
    /check_group 3.1 - –ø–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –≥—Ä—É–ø–ø—ã 3.1
    """
    group_name = message.text.replace('/check_group', '').strip()
    
    # 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à –≥—Ä—É–ø–ø—ã
    cache = await get_group_cache(ctx.db_conn, group_name, ctx.provider_code)
    
    if cache:
        # –ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –∏–∑ –∫—ç—à–∞
        await send_schedule_response(message, cache['data'], ...)
    else:
        # –ù–∞–π—Ç–∏ –ª—é–±–æ–π –∞–¥—Ä–µ—Å –∏–∑ —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã
        addresses = await find_addresses_by_group(ctx.db_conn, ctx.provider_code, group_name, limit=1)
        
        if addresses:
            # –ó–∞–ø—Ä–æ—Å–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è —ç—Ç–æ–≥–æ –∞–¥—Ä–µ—Å–∞
            addr = addresses[0]
            data = await get_shutdowns_data(addr['city'], addr['street'], addr['house'])
            await update_group_cache(...)
            await send_schedule_response(message, data, ...)
        else:
            await message.answer(
                f"–ì—Ä—É–ø–∞ {group_name} –ø–æ–∫–∏ –Ω–µ–≤—ñ–¥–æ–º–∞. "
                f"–í–∫–∞–∂—ñ—Ç—å –∞–¥—Ä–µ—Å—É –∑ —Ü—ñ—î—ó –≥—Ä—É–ø–∏ –∫–æ–º–∞–Ω–¥–æ—é /check"
            )
```

### Phase 3: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

Dashboard —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏:
- Cache hit rate –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- –¢–æ–ø-10 –≥—Ä—É–ø–ø –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø—Ä–æ—Å–æ–≤
- –†–æ—Å—Ç –±–∞–∑—ã –∞–¥—Ä–µ—Å–æ–≤ (–≥—Ä–∞—Ñ–∏–∫)
- –≠–∫–æ–Ω–æ–º–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `docker-compose logs -f <service>`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î: `sqlite3 <path> "SELECT * FROM group_schedule_cache LIMIT 5;"`
3. –û—Ç–∫–∞—Ç–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (–∫—ç—à –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω, –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ READY FOR DEPLOYMENT
**–î–∞—Ç–∞**: 2025-12-11
**–í–µ—Ä—Å–∏—è –ë–î**: 5 (migration 005_group_schedule_cache)
