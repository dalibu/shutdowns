# –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ –≥—Ä—É–ø–ø–∞–º - –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** 
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ 2 –∞–¥—Ä–µ—Å–∞ –∏–∑ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–º –∏ –¥–∞—á–∞)
- –ü–æ–ª—É—á–∞–µ—Ç 2 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞
- –ì—Ä–∞—Ñ–∏–∫-—Ç–æ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –¥–ª—è –≤—Å–µ–π –≥—Ä—É–ø–ø—ã!

## –†–µ—à–µ–Ω–∏–µ: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ (user_id, group_name)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

**–¢–∞–±–ª–∏—Ü–∞ `subscriptions`:**
```sql
CREATE TABLE subscriptions (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    address_id INTEGER NOT NULL,  -- —Å—Å—ã–ª–∫–∞ –Ω–∞ addresses
    interval_hours REAL,
    next_check TIMESTAMP,
    last_schedule_hash TEXT,
    notification_lead_time INTEGER DEFAULT 0,
    last_alert_event_start TIMESTAMP,
    UNIQUE(user_id, address_id)
)
```

**–¢–∞–±–ª–∏—Ü–∞ `addresses`:**
```sql
CREATE TABLE addresses (
    id INTEGER PRIMARY KEY,
    provider TEXT,
    city TEXT,
    street TEXT,
    house TEXT,
    group_name TEXT,  -- ‚Üê –ö–ª—é—á–µ–≤–æ–µ –ø–æ–ª–µ!
    ...
)
```

### –ê–ª–≥–æ—Ä–∏—Ç–º

#### 1. Subscription Checker Task

**–ë—ã–ª–æ:**
```
–î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–¥–ø–∏—Å–∫–∏:
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å schedule
  - –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

**–°—Ç–∞–Ω–µ—Ç:**
```
1. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏, require checking
2. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ (user_id, group_name)
3. –î–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ (–∏—Å–ø–æ–ª—å–∑—É—è –∫—ç—à –≥—Ä—É–ø–ø—ã!)
   - –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è –≥—Ä–∞—Ñ–∏–∫:
     - –°–æ–±—Ä–∞—Ç—å –í–°–ï –∞–¥—Ä–µ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã
     - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –û–î–ù–û —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º –∞–¥—Ä–µ—Å–æ–≤
4. –û–±–Ω–æ–≤–∏—Ç—å next_check –¥–ª—è –í–°–ï–• –ø–æ–¥–ø–∏—Å–æ–∫ –≤ –≥—Ä—É–ø–ø–µ
```

#### 2. Alert Checker Task

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ:**
```
1. –ü–æ–ª—É—á–∏—Ç—å subscriptions —Å notification_lead_time > 0
2. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ (user_id, group_name)
3. –î–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –æ–¥–∏–Ω —Ä–∞–∑
   - –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –±–ª–∏–∑–∫–æ:
     - –°–æ–±—Ä–∞—Ç—å –≤—Å–µ –∞–¥—Ä–µ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –û–î–ù–û —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

### –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π

**–°–ª—É—á–∞–π 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å–æ–≤ –≤ –≥—Ä—É–ø–ø–µ**
```markdown
‚ö° –ó–º—ñ–Ω–∞ –≥—Ä–∞—Ñ—ñ–∫—É –¥–ª—è —á–µ—Ä–≥–∏ 3.1

üìç –í–∞—à—ñ –∞–¥—Ä–µ—Å–∏ –≤ —Ü—ñ–π —á–µ—Ä–∑—ñ:
   ‚Ä¢ –º. –î–Ω—ñ–ø—Ä–æ, –≤—É–ª. –°–æ–Ω—è—á–Ω–∞ –Ω–∞–±–µ—Ä–µ–∂–Ω–∞, 6
   ‚Ä¢ –º. –î–Ω—ñ–ø—Ä–æ, –≤—É–ª. –†–æ–±–æ—á–∞, 15

[–¥–∏–∞–≥—Ä–∞–º–º–∞]
```

**–°–ª—É—á–∞–π 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –æ–¥–∏–Ω –∞–¥—Ä–µ—Å –≤ –≥—Ä—É–ø–ø–µ**
```markdown
‚ö° –ó–º—ñ–Ω–∞ –≥—Ä–∞—Ñ—ñ–∫—É –¥–ª—è —á–µ—Ä–≥–∏ 3.1

üìç –ê–¥—Ä–µ—Å–∞: –º. –î–Ω—ñ–ø—Ä–æ, –≤—É–ª. –°–æ–Ω—è—á–Ω–∞ –Ω–∞–±–µ—Ä–µ–∂–Ω–∞, 6

[–¥–∏–∞–≥—Ä–∞–º–º–∞]
```

**–°–ª—É—á–∞–π 3: –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≥—Ä—É–ø–ø—É –±–µ–∑ –∞–¥—Ä–µ—Å–∞ (–±—É–¥—É—â–∞—è feature)**
```markdown
‚ö° –ó–º—ñ–Ω–∞ –≥—Ä–∞—Ñ—ñ–∫—É –¥–ª—è —á–µ—Ä–≥–∏ 3.1

[–¥–∏–∞–≥—Ä–∞–º–º–∞]
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ **–ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è** - –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –≥—Ä—É–ø–ø—É
‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å** - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –≥—Ä—É–ø–ø
‚úÖ **–ö–æ–Ω—Ç–µ–∫—Å—Ç** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≤—Å–µ —Å–≤–æ–∏ –∞–¥—Ä–µ—Å–∞
‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å–∞–º

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

#### –§–∞–π–ª—ã –¥–ª—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏:

1. **`common/tasks.py`**
   - `subscription_checker_task()` - –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ (user_id, group)
   - `alert_checker_task()` - —Ç–æ –∂–µ —Å–∞–º–æ–µ
   
2. **`common/formatting.py`** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–æ–≤

### SQL –∑–∞–ø—Ä–æ—Å—ã

**–ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ user + group:**
```sql
SELECT 
    s.user_id,
    a.group_name,
    GROUP_CONCAT(a.id) as address_ids,
    GROUP_CONCAT(a.city || ', ' || a.street || ', ' || a.house, ' | ') as addresses,
    MIN(s.interval_hours) as interval_hours,
    MIN(s.last_schedule_hash) as last_schedule_hash
FROM subscriptions s
JOIN addresses a ON a.id = s.address_id
WHERE s.next_check <= ?
GROUP BY s.user_id, a.group_name
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases

1. **group_name = NULL:**
   - –ê–¥—Ä–µ—Å –µ—â–µ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª—Å—è
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—É—é –≥—Ä—É–ø–ø—É (–±–µ–∑ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏)

2. **–†–∞–∑–Ω—ã–µ interval_hours –¥–ª—è –∞–¥—Ä–µ—Å–æ–≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MIN (—Å–∞–º—ã–π —á–∞—Å—Ç—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª)
   - –ò–ª–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å all subscriptions –≤ –≥—Ä—É–ø–ø–µ –Ω–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π next_check

3. **–•—ç—à–∏ —Ä–∞–∑–Ω—ã–µ –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫ –≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–µ:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω —Ö—ç—à –∏–∑ –∫—ç—à–∞ –≥—Ä—É–ø–ø—ã
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏

## –≠—Ç–∞–ø—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤ subscription_checker
- [ ] –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
- [ ] –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ –≥—Ä—É–ø–ø—ã –≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- [ ] –û–±–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π

### –≠—Ç–∞–ø 2: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤ alert_checker  
- [ ] –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ subscription_checker
- [ ] –£—á–µ—Å—Ç—å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ alert –ª–æ–≥–∏–∫–∏

### –≠—Ç–∞–ø 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –≠—Ç–∞–ø 4: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
- [ ] –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –≥—Ä—É–ø–ø—É –Ω–∞–ø—Ä—è–º—É—é (/subscribe 3.1)
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ö—ç—à–µ–π –≤ –≥—Ä—É–ø–ø–∞—Ö
