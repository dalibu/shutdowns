# –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –∏–∑–º–µ–Ω–µ–Ω–∏–π subscription_checker_task

## –¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)

```python
1. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ subscriptions –≥–¥–µ next_check <= now
2. –î–ª—è –∫–∞–∂–¥–æ–π subscription:
   - city, street, house, user_id
3. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∞–¥—Ä–µ—Å–∞–º to avoid duplicate API calls
4. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞:
   - –í—ã–∑–≤–∞—Ç—å API / –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à
   - –ü–æ–ª—É—á–∏—Ç—å schedule
5. –î–ª—è –∫–∞–∂–¥–æ–≥–æ user_id —Å —ç—Ç–∏–º –∞–¥—Ä–µ—Å–æ–º:
   - –ï—Å–ª–∏ schedule –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
   - –û–±–Ω–æ–≤–∏—Ç—å next_check –∏ last_schedule_hash
```

## –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ user + group)

```python
1. –ü–æ–ª—É—á–∏—Ç—å subscriptions –≥–¥–µ next_check <= now, GROUP BY (user_id, group_name)
   - –î–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã: —Å–ø–∏—Å–æ–∫ address_ids –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ group_name –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ API calls
3. –î–ª—è –∫–∞–∂–¥–æ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ–π group:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å group_cache
   - –ï—Å–ª–∏ stale ‚Üí –≤–∑—è—Ç—å –ø–µ—Ä–≤—ã–π –∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–¥—Ä–µ—Å, –≤—ã–∑–≤–∞—Ç—å API
   - –û–±–Ω–æ–≤–∏—Ç—å group_cache
4. –î–ª—è –∫–∞–∂–¥–æ–π (user_id, group_name) –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏:
   - –ï—Å–ª–∏ schedule –∏–∑–º–µ–Ω–∏–ª—Å—è:
     ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å –û–î–ù–û —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º –∞–¥—Ä–µ—Å–æ–≤
   - –û–±–Ω–æ–≤–∏—Ç—å next_check –¥–ª—è –í–°–ï–• address_ids –≤ –≥—Ä—É–ø–ø–µ
```

## –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. SQL –∑–∞–ø—Ä–æ—Å

**–ë—ã–ª–æ:**
```sql
SELECT s.user_id, a.city, a.street, a.house, s.interval_hours, s.last_schedule_hash
FROM subscriptions s
JOIN addresses a ON a.id = s.address_id
WHERE s.next_check <= ?
```

**–°—Ç–∞–ª–æ:**
```sql
SELECT 
    s.user_id,
    a.group_name,
    GROUP_CONCAT(a.id, '|') as address_ids,
    GROUP_CONCAT(a.city || '::' || a.street || '::' || a.house, '|') as addresses,
    MIN(s.interval_hours) as interval_hours,
    MIN(s.last_schedule_hash) as last_schedule_hash
FROM subscriptions s
JOIN addresses a ON a.id = s.address_id
WHERE s.next_check <= ?
GROUP BY s.user_id, a.group_name
```

### 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

**–ë—ã–ª–æ:**
```python
users_to_check = [
    {
        'user_id': 123,
        'city': '–º. –î–Ω—ñ–ø—Ä–æ',
        'street': '–≤—É–ª. –°–æ–Ω—è—á–Ω–∞ –Ω–∞–±–µ—Ä–µ–∂–Ω–∞',
        'house': '6',
        'interval_hours': 1.0,
        'last_schedule_hash': 'abc123'
    },
    ...
]
```

**–°—Ç–∞–ª–æ:**
```python
groups_to_check = [
    {
        'user_id': 123,
        'group_name': '3.1',
        'address_ids': [45, 67],  # –≤—Å–µ –∞–¥—Ä–µ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ
        'addresses': [
            {'city': '–º. –î–Ω—ñ–ø—Ä–æ', 'street': '–≤—É–ª. –°–æ–Ω—è—á–Ω–∞ –Ω–∞–±–µ—Ä–µ–∂–Ω–∞', 'house': '6'},
            {'city': '–º. –î–Ω—ñ–ø—Ä–æ', 'street': '–≤—É–ª. –†–æ–±–æ—á–∞', 'house': '15'}
        ],
        'interval_hours': 1.0,
        'last_schedule_hash': 'abc123'
    },
    ...
]
```

### 3. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–ª—è API calls

**–ë—ã–ª–æ:**
```python
addresses_to_check_map = {
    ('–º. –î–Ω—ñ–ø—Ä–æ', '–≤—É–ª. –°–æ–Ω—è—á–Ω–∞ –Ω–∞–±–µ—Ä–µ–∂–Ω–∞', '6'): [user_id_1, user_id_2],
    ...
}
```

**–°—Ç–∞–ª–æ:**
```python
groups_to_check_map = {
    '3.1': {
        'group_name': '3.1',
        'sample_address': {'city': '–º. –î–Ω—ñ–ø—Ä–æ', 'street': '...', 'house': '6'},
        'users': [
            {
                'user_id': 123,
                'address_ids': [45, 67],
                'addresses': [...]
            }
        ]
    },
    ...
}
```

### 4. –§–æ—Ä–º–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ë—ã–ª–æ:**
```python
message_parts.append(f"üìç –ê–¥—Ä–µ—Å–∞: `{city}, {street}, {house}`\nüë• –ß–µ—Ä–≥–∞: `{group}`")
```

**–°—Ç–∞–ª–æ:**
```python
if len(addresses) == 1:
    # –û–¥–∏–Ω –∞–¥—Ä–µ—Å
    addr = addresses[0]
    message_parts.append(f"üìç –ê–¥—Ä–µ—Å–∞: `{addr['city']}, {addr['street']}, {addr['house']}`\nüë• –ß–µ—Ä–≥–∞: `{group}`")
else:
    # –ù–µ—Å–∫–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å–æ–≤
    message_parts.append(f"üë• –ß–µ—Ä–≥–∞: `{group}`")
    message_parts.append("üìç –í–∞—à—ñ –∞–¥—Ä–µ—Å–∏ –≤ —Ü—ñ–π —á–µ—Ä–∑—ñ:")
    for addr in addresses:
        message_parts.append(f"   ‚Ä¢ `{addr['city']}, {addr['street']}, {addr['house']}`")
```

### 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î

**–ë—ã–ª–æ:**
```python
UPDATE subscriptions 
SET next_check = ?, last_schedule_hash = ? 
WHERE user_id = ? AND address_id = ?

# –î–ª—è –∫–∞–∂–¥–æ–π subscription –æ—Ç–¥–µ–ª—å–Ω–æ
```

**–°—Ç–∞–ª–æ:**
```python
UPDATE subscriptions 
SET next_check = ?, last_schedule_hash = ? 
WHERE user_id = ? AND address_id IN (?, ?, ...)

# –î–ª—è –≤—Å–µ—Ö address_ids –≤ –≥—Ä—É–ø–ø–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
```

## –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: group_name = NULL
**–ü—Ä–∏—á–∏–Ω–∞:** –ê–¥—Ä–µ—Å –µ—â–µ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª—Å—è, –≥—Ä—É–ø–ø–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞
**–†–µ—à–µ–Ω–∏–µ:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—É—é "–≥—Ä—É–ø–ø—É" –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–¥—Ä–µ—Å–∞

```python
if group_name is None:
    # Treat as individual subscription (no grouping)
    group_key = f"unknown_{address_id}"
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –†–∞–∑–Ω—ã–µ interval_hours –≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–µ
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–ø–∏—Å–∞–ª—Å—è –Ω–∞ –∞–¥—Ä–µ—Å–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MIN (—Å–∞–º—ã–π —á–∞—Å—Ç—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª)

–£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ SQL: `MIN(s.interval_hours)`

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –†–∞–∑–Ω—ã–µ last_schedule_hash –≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–µ
**–ü—Ä–∏—á–∏–Ω–∞:** –î–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ:** –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –≥—Ä—É–ø–ø–µ –Ω–∞ –æ–¥–∏–Ω —Ö—ç—à

```python
# –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–±–Ω–æ–≤–∏—Ç—å –í–°–ï –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –≥—Ä—É–ø–ø–µ
for address_id in address_ids:
    update_hash(user_id, address_id, new_hash)
```

## –ü–æ—à–∞–≥–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –®–∞–≥ 1: –ò–∑–º–µ–Ω–∏—Ç—å SQL –∑–∞–ø—Ä–æ—Å ‚úì
- [x] GROUP BY user_id, group_name
- [x] GROUP_CONCAT –¥–ª—è address_ids –∏ addresses

### –®–∞–≥ 2: –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- [ ] –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å address_ids (—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å |)
- [ ] –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å addresses (—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å |, –≤–Ω—É—Ç—Ä–∏ ::)
- [ ] –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É groups_to_check

### –®–∞–≥ 3: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ groups –¥–ª—è API
- [ ] –í–º–µ—Å—Ç–æ addresses_to_check_map —Å–æ–∑–¥–∞—Ç—å groups_to_check_map
- [ ] –î–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã –≤–∑—è—Ç—å –ø–µ—Ä–≤—ã–π sample_address

### –®–∞–≥ 4: API calls —Å group cache
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å group_cache –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã
- [ ] –ï—Å–ª–∏ stale ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å sample_address –¥–ª—è API call
- [ ] –û–±–Ω–æ–≤–∏—Ç—å group_cache

### –®–∞–≥ 5: –û–±–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ–¥–Ω–æ–≥–æ vs –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞–¥—Ä–µ—Å–æ–≤
- [ ] –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤ –∫—Ä–∞—Å–∏–≤–æ

### –®–∞–≥ 6: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î
- [ ] UPDATE –¥–ª—è –≤—Å–µ—Ö address_ids –≤ –≥—Ä—É–ø–ø–µ
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WHERE address_id IN (...)

### –®–∞–≥ 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] Unit —Ç–µ—Å—Ç—ã –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
- [ ] Integration —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ production-like –¥–∞–Ω–Ω—ã—Ö

## –û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

- –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è: ~100-150
- –ù–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π: 1-2 helper functions
- –†–∏—Å–∫: –°—Ä–µ–¥–Ω–∏–π (core —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)
- –í—Ä–µ–º—è: 1-2 —á–∞—Å–∞ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

## Rollback –ø–ª–∞–Ω

–í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º:
1. Revert –∫–æ–º–º–∏—Ç–∞
2. –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ feature/group-check –±–µ–∑ notification grouping
3. –î–µ–ø–ª–æ–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –ø–æ–∑–∂–µ
