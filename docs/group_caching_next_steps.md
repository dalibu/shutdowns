# Group Caching Optimization - Implementation Summary

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ‚úÖ
- **–§–∞–π–ª**: `common/migrations/005_group_schedule_cache.sql`
- **–¢–∞–±–ª–∏—Ü—ã**:
  - `group_schedule_cache` - –∫—ç—à –≥—Ä–∞—Ñ–∏–∫–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º
  - `address_group_mapping` - –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π –∞–¥—Ä–µ—Å ‚Üí –≥—Ä—É–ø–ø–∞
- **–°—Ç–∞—Ç—É—Å**: –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ –æ–±–µ–∏–º –ë–î (dtek, cek)

### 2. API —Ñ—É–Ω–∫—Ü–∏–∏ ‚úÖ
- **–§–∞–π–ª**: `common/bot_base.py`
- **–î–æ–±–∞–≤–ª–µ–Ω–æ**:
  - `get_group_cache()` - –ø–æ–ª—É—á–∏—Ç—å –∫—ç—à –≥—Ä—É–ø–ø—ã
  - `update_group_cache()` - –æ–±–Ω–æ–≤–∏—Ç—å –∫—ç—à –≥—Ä—É–ø–ø—ã
  - `get_cached_group_for_address()` - —É–∑–Ω–∞—Ç—å –≥—Ä—É–ø–ø—É –¥–ª—è –∞–¥—Ä–µ—Å–∞
  - `get_group_for_address()` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –≥—Ä—É–ø–ø—ã
  - `update_address_group_mapping()` - –∑–∞–ø–∏—Å–∞—Ç—å –∞–¥—Ä–µ—Å ‚Üí –≥—Ä—É–ø–ø–∞
  - `find_addresses_by_group()` - –Ω–∞–π—Ç–∏ –∞–¥—Ä–µ—Å–∞ –ø–æ –≥—Ä—É–ø–ø–µ

### 3. –ò–º–ø–æ—Ä—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã ‚úÖ
- **–§–∞–π–ª**: `common/tasks.py`
- –í—Å–µ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ‚úÖ
- **–§–∞–π–ª**: `docs/group_caching_architecture.md`
- –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, API, –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (TODO)

### –®–∞–≥ 1: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ subscription_checker_task

**–§–∞–π–ª**: `common/tasks.py` (—Å—Ç—Ä–æ–∫–∏ 280-320)

–ù—É–∂–Ω–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥—Ä–µ—Å–æ–≤:

```python
# –í —Ü–∏–∫–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥—Ä–µ—Å–æ–≤ (—Å—Ç—Ä–æ–∫–∞ ~281)
for address_key in addresses_to_check_map.keys():
    city, street, house = address_key
    address_str = f"`{city}, {street}, {house}`"
    
    try:
        logger.debug(f"Calling parser for address {address_str}")
        
        # === –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê === 
        # 1. –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ –≥—Ä—É–ø–ø—É –¥–ª—è –∞–¥—Ä–µ—Å–∞
        cached_group = await get_group_for_address(
            db_conn, ctx.provider_code, city, street, house
        )
        
        if cached_group:
            # 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à –≥—Ä—É–ø–ø—ã
            group_cache = await get_group_cache(
                db_conn, cached_group, ctx.provider_code
            )
            
            if group_cache:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à!
                logger.info(f"Using group cache for {address_str}, group {cached_group}")
                data = group_cache['data']
                current_hash = group_cache['hash']
            else:
                # –ö—ç—à —É—Å—Ç–∞—Ä–µ–ª, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å –∏–∑–≤–µ—Å—Ç–Ω–æ–π –≥—Ä—É–ø–ø–æ–π
                logger.info(f"Group cache stale, fetching for {address_str}")
                if get_cached_group and cached_group:
                    data = await get_shutdowns_data(city, street, house, cached_group)
                else:
                    data = await get_shutdowns_data(city, street, house)
                
                current_hash = get_schedule_hash_compact(data)
                
                # –û–±–Ω–æ–≤–∏—Ç—å –∫—ç—à –≥—Ä—É–ø–ø—ã
                if data.get('group'):
                    await update_group_cache(
                        db_conn, data['group'], ctx.provider_code,
                        current_hash, data
                    )
        else:
            # –ì—Ä—É–ø–ø–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞ - –ø–æ–ª–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥
            logger.info(f"Unknown group, full parsing for {address_str}")
            data = await get_shutdowns_data(city, street, house)
            current_hash = get_schedule_hash_compact(data)
        
        # 3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∞–¥—Ä–µ—Å ‚Üí –≥—Ä—É–ø–ø–∞
        if data.get('group'):
            await update_address_group_mapping(
                db_conn, ctx.provider_code,
                city, street, house, data['group']
            )
            
            # –û–±–Ω–æ–≤–∏—Ç—å –∫—ç—à –≥—Ä—É–ø–ø—ã (–µ—Å–ª–∏ –Ω–µ –¥–µ–ª–∞–ª–∏ –≤—ã—à–µ)
            if not cached_group or not group_cache:
                await update_group_cache(
                    db_conn, data['group'], ctx.provider_code,
                    current_hash, data
                )
        
        # === –ö–û–ù–ï–¶ –ù–û–í–û–ô –õ–û–ì–ò–ö–ò ===
        
        # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
        ADDRESS_CACHE[address_key] = {
            'last_schedule_hash': current_hash,
            'last_checked': now
        }
        SCHEDULE_DATA_CACHE[address_key] = data
        api_results[address_key] = data
        
    except Exception as e:
        logger.error(f"Error checking address {address_str}: {e}")
        api_results[address_key] = {"error": str(e)}
```

### –®–∞–≥ 2: –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ handlers

**–§–∞–π–ª—ã**: 
- `common/handlers.py` - —Ñ—É–Ω–∫—Ü–∏–∏ `handle_process_house`, `send_schedule_response`
- `cek/bot/bot.py`, `dtek/bot/bot.py` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏

–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ—Ö–æ–∂—É—é –ª–æ–≥–∏–∫—É:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–≤–µ—Å—Ç–Ω–∞ –ª–∏ –≥—Ä—É–ø–ø–∞
2. –ï—Å–ª–∏ –¥–∞ - –ø–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à
3. –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è—Ç—å `address_group_mapping`

### –®–∞–≥ 3: –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/check_group` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ö—ç–Ω–¥–ª–µ—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –≥—Ä—É–ø–ø–µ (—Å–º. –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é).

### –®–∞–≥ 4: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ –ª–æ–≥–∏**:
   ```python
   logger.info(f"Cache hit for group {group_name}")
   logger.info(f"Cache miss for group {group_name}, parsing...")
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–æ—Å—Ç –±–∞–∑—ã –∞–¥—Ä–µ—Å–æ–≤**:
   ```sql
   SELECT COUNT(*) FROM address_group_mapping;
   SELECT group_name, COUNT(*) as addr_count 
   FROM address_group_mapping 
   WHERE provider = 'dtek' 
   GROUP BY group_name 
   ORDER BY addr_count DESC;
   ```

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å hit rate –∫—ç—à–∞**:
   - –°—á–∏—Ç–∞—Ç—å —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ cache_hit / total_checks

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**: N –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É = N —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤
- **–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**: N –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É ‚âà M –≥—Ä—É–ø–ø (–≥–¥–µ M << N)

### –ü—Ä–∏–º–µ—Ä
- 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–¥—Ä–µ—Å–∞–º–∏ –∏–∑ 10 –≥—Ä—É–ø–ø
- –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏: 1 —á–∞—Å
- TTL –∫—ç—à–∞: 15 –º–∏–Ω—É—Ç

**–î–æ**: 100 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å –∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É
**–ü–æ—Å–ª–µ**: ~10 –∑–∞–ø—Ä–æ—Å–æ–≤/15 –º–∏–Ω = 40 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å –∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É (–ø–µ—Ä–≤—ã–µ 15 –º–∏–Ω), –∑–∞—Ç–µ–º ~10 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã–≥–æ–¥—ã
- –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ –∫—ç—à–∞ (–±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è –ø–∞—Ä—Å–µ—Ä–∞)
- –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∞–¥—Ä–µ—Å–æ–≤ —Ä–∞—Å—Ç—ë—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ñ—É–Ω–∫—Ü–∏–∏ `/check_group`

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã
```bash
sqlite3 dtek/bot/dtek_bot.db
> .schema group_schedule_cache
> .schema address_group_mapping
> SELECT * FROM group_schedule_cache LIMIT 5;
> SELECT * FROM address_group_mapping LIMIT 5;
```

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
```bash
# –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∞–¥—Ä–µ—Å
/subscribe –º. –î–Ω—ñ–ø—Ä–æ, –≤—É–ª. –°–æ–Ω—è—á–Ω–∞ –Ω–∞–±–µ—Ä–µ–∂–Ω–∞, 6

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# "Updated address-group mapping: ... -> 3.1"
# "Updated group cache for 3.1"
```

### 3. –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π –∞–¥—Ä–µ—Å —Ç–æ–π –∂–µ –≥—Ä—É–ø–ø—ã
```bash
/subscribe –º. –î–Ω—ñ–ø—Ä–æ, –≤—É–ª. –Ü–Ω—à–∞ –≤—É–ª–∏—Ü—è, 10

# –ï—Å–ª–∏ –∞–¥—Ä–µ—Å –∏–∑ –≥—Ä—É–ø–ø—ã 3.1, –≤ –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# "Using group cache for 3.1"
# –ë–µ–∑ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞!
```

## üöÄ –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤ production

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏**:
1. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
2. ‚úÖ –§—É–Ω–∫—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã
3. ‚è≥ –õ–æ–≥–∏–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ subscription_checker_task
4. ‚è≥ –õ–æ–≥–∏–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ handlers
5. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏
6. ‚è≥ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ü–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ subscription_checker_task –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ:
- –î–µ–Ω—å 1-2: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏
- –î–µ–Ω—å 3-7: –ê–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫ (hit rate, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤)
- –ù–µ–¥–µ–ª—è 2+: –ü–æ–ª–Ω—ã–π rollout

## ‚ùì –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è

1. **TTL –∫—ç—à–∞ 15 –º–∏–Ω—É—Ç** - –ø–æ–¥—Ö–æ–¥–∏—Ç –ª–∏? –ú–æ–∂–µ—Ç –±—ã—Ç—å —É–≤–µ–ª–∏—á–∏—Ç—å?
2. **–ù—É–∂–Ω–∞ –ª–∏ –∫–æ–º–∞–Ω–¥–∞ `/check_group`** —Å—Ä–∞–∑—É –∏–ª–∏ –ø–æ–∑–∂–µ?
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –∫–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –≤–∞–∂–Ω—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è?
4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** - –≥–æ–≤–æ—Ä–∏—Ç—å –ª–∏ —á—Ç–æ –æ—Ç–≤–µ—Ç –∏–∑ –∫—ç—à–∞?
