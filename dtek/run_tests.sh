#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./run_tests.sh [–æ–ø—Ü–∏–∏]

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ DTEK Telegram Bot${NC}\n"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ pytest
if ! command -v pytest &> /dev/null; then
    echo -e "${RED}‚ùå pytest –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!${NC}"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install pytest pytest-asyncio pytest-mock pytest-cov"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -f "dtek_telegram_bot.py" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: dtek_telegram_bot.py –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏${NC}"
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞"
fi

if [ ! -d "tests" ]; then
    echo -e "${RED}‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è tests/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!${NC}"
    exit 1
fi

# --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –∑–∞–ø—É—Å–∫–∞ ---
# –í–º–µ—Å—Ç–æ CMD="PYTHONPATH=. pytest tests/", –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∞—Å—Å–∏–≤
# –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞–ø—Ä—è–º—É—é —Å —ç–∫—Å–ø–æ—Ä—Ç–æ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π.
# –õ—É—á—à–∏–π —Å–ø–æ—Å–æ–± - —ç—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å export –ø–µ—Ä–µ–¥ –∫–æ–º–∞–Ω–¥–æ–π –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ.
# –ù–∏–∂–µ –ø–æ–∫–∞–∑–∞–Ω—ã –æ–±–∞ —Å–ø–æ—Å–æ–±–∞. –Ø –≤—ã–±–µ—Ä—É —Å–ø–æ—Å–æ–± —Å export.

# --- –°–ø–æ—Å–æ–± 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å export ---
export PYTHONPATH="."

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –∑–∞–ø—É—Å–∫–∞ –±–µ–∑ PYTHONPATH –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏
CMD="pytest tests/"

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
case "${1:-all}" in
    all)
        echo -e "${GREEN}üìã –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤${NC}\n"
        $CMD -v
        ;;
    unit)
        echo -e "${GREEN}üìã –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤${NC}\n"
        $CMD -m unit -v
        ;;
    api)
        echo -e "${GREEN}üìã –ó–∞–ø—É—Å–∫ API —Ç–µ—Å—Ç–æ–≤${NC}\n"
        $CMD -m api -v
        ;;
    db)
        echo -e "${GREEN}üìã –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ë–î${NC}\n"
        $CMD -m db -v
        ;;
    integration)
        echo -e "${GREEN}üìã –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤${NC}\n"
        $CMD -m integration -v
        ;;
    format)
        echo -e "${GREEN}üìã –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è${NC}\n"
        $CMD -m format -v
        ;;
    captcha)
        echo -e "${GREEN}üìã –ó–∞–ø—É—Å–∫ CAPTCHA —Ç–µ—Å—Ç–æ–≤${NC}\n"
        $CMD -m captcha -v
        ;;
    cov|coverage)
        echo -e "${GREEN}üìä –ó–∞–ø—É—Å–∫ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞${NC}\n"
        $CMD --cov=dtek_telegram_bot --cov-report=html --cov-report=term-missing
        echo -e "\n${GREEN}‚úÖ HTML –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω –≤ htmlcov/index.html${NC}"
        ;;
    quick)
        echo -e "${GREEN}‚ö° –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ (–±–µ–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤)${NC}\n"
        $CMD -m "not slow" -v
        ;;
    failed)
        echo -e "${GREEN}üîÑ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ —É–ø–∞–≤—à–∏—Ö —Ç–µ—Å—Ç–æ–≤${NC}\n"
        $CMD --lf -v
        ;;
    debug)
        echo -e "${GREEN}üêõ –ó–∞–ø—É—Å–∫ —Å –æ—Ç–ª–∞–¥—á–∏–∫–æ–º${NC}\n"
        $CMD --pdb -v
        ;;
    verbose)
        echo -e "${GREEN}üì¢ –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥${NC}\n"
        $CMD -vv -s
        ;;
    help|--help|-h)
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./run_tests.sh [–∫–æ–º–∞–Ω–¥–∞]"
        echo ""
        echo "–ö–æ–º–∞–Ω–¥—ã:"
        echo "  all         - –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
        echo "  unit        - –¢–æ–ª—å–∫–æ unit —Ç–µ—Å—Ç—ã"
        echo "  api         - –¢–æ–ª—å–∫–æ API —Ç–µ—Å—Ç—ã"
        echo "  db          - –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã –ë–î"
        echo "  integration - –¢–æ–ª—å–∫–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã"
        echo "  format      - –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
        echo "  captcha     - –¢–æ–ª—å–∫–æ CAPTCHA —Ç–µ—Å—Ç—ã"
        echo "  coverage    - –ó–∞–ø—É—Å–∫ —Å –æ—Ç—á–µ—Ç–æ–º –æ –ø–æ–∫—Ä—ã—Ç–∏–∏"
        echo "  quick       - –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ (–±–µ–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö)"
        echo "  failed      - –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–æ–ª—å–∫–æ —É–ø–∞–≤—à–∏–µ —Ç–µ—Å—Ç—ã"
        echo "  debug       - –ó–∞–ø—É—Å–∫ —Å –æ—Ç–ª–∞–¥—á–∏–∫–æ–º (--pdb)"
        echo "  verbose     - –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥"
        echo "  help        - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
        echo ""
        echo "–ü—Ä–∏–º–µ—Ä—ã:"
        echo "  ./run_tests.sh"
        echo "  ./run_tests.sh unit"
        echo "  ./run_tests.sh coverage"
        exit 0
        ;;
    *)
        echo -e "${RED}‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: $1${NC}"
        echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ './run_tests.sh help' –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏"
        exit 1
        ;;
esac

# –ö–æ–¥ –≤—ã—Ö–æ–¥–∞ pytest
EXIT_CODE=$?

if [ $EXIT_CODE -eq 0 ]; then
    echo -e "\n${GREEN}‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!${NC}"
else
    echo -e "\n${RED}‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏ (–∫–æ–¥: $EXIT_CODE)${NC}"
    echo -e "${YELLOW}üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: ./run_tests.sh debug${NC}"
fi

exit $EXIT_CODE